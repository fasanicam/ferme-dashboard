<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Analyse MQTT - Ferme connect√©e</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
</head>

<body class="bg-gray-100 text-gray-800 font-sans p-6">

    <!-- Header -->
    <div class="relative flex justify-between items-center mb-8">
        <div class="flex items-center gap-4">
            <a href="/" class="bg-white p-2 rounded-full shadow hover:shadow-md transition-all text-2xl"
                title="Retour au Dashboard">üè†</a>
            <h1
                class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-500 drop-shadow-sm">
                üìä Analyse & Scoring MQTT
            </h1>
        </div>
        <div class="text-sm text-gray-500">
            Derni√®re mise √† jour: <span id="last-update">Maintenant</span>
        </div>
    </div>

    <!-- Global Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Messages -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500">
            <h3 class="text-gray-500 font-medium mb-1">Messages Analys√©s</h3>
            <p class="text-3xl font-bold text-gray-800">{{ global_stats.total_messages }}</p>
            <p class="text-xs text-gray-400 mt-2">Sur l'ensemble de l'historique</p>
        </div>

        <!-- Compliance Rate -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500">
            <h3 class="text-gray-500 font-medium mb-1">Conformes ‚úÖ</h3>
            <div class="flex items-end gap-2">
                <p class="text-3xl font-bold text-green-600">{{ global_stats.compliant_messages }}</p>
                <span class="text-sm mb-1 text-green-500">{{ global_stats.compliance_rate }}%</span>
            </div>
            <p class="text-xs text-gray-400 mt-2">Respectent le format attendu</p>
        </div>

        <!-- Non-Compliant -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-red-500">
            <h3 class="text-gray-500 font-medium mb-1">Non Conformes ‚ùå</h3>
            <div class="flex items-end gap-2">
                <p class="text-3xl font-bold text-red-600">{{ global_stats.non_compliant_messages }}</p>
                <span class="text-sm mb-1 text-red-500">{{ 100 - global_stats.compliance_rate }}%</span>
            </div>
            <p class="text-xs text-gray-400 mt-2">Format incorrect (trop de niveaux, structure invalide...)</p>
        </div>

        <!-- Active Projects -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500">
            <h3 class="text-gray-500 font-medium mb-1">Projets Actifs (24h)</h3>
            <p class="text-3xl font-bold text-gray-800">{{ global_stats.active_projects }}</p>
            <p class="text-xs text-gray-400 mt-2">Ayant publi√© au moins un message</p>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
        {% for cat, count in global_stats.categories.items() %}
        <div class="bg-white rounded-xl shadow p-4 text-center
        {% if cat == 'dashboard' %}border-t-4 border-green-400
        {% elif cat == 'capteurs' %}border-t-4 border-blue-400
        {% elif cat == 'actionneurs' %}border-t-4 border-indigo-400
        {% elif cat == 'project_structure_error' %}border-t-4 border-red-400
        {% else %}border-t-4 border-gray-400{% endif %}">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">
                {% if cat == 'dashboard' %}üñ•Ô∏è Dashboard
                {% elif cat == 'capteurs' %}üì° Capteurs
                {% elif cat == 'actionneurs' %}‚öôÔ∏è Actionneurs
                {% elif cat == 'project_structure_error' %}‚ö†Ô∏è Structure Erreur
                {% elif cat == 'other' %}‚ùì Autre
                {% else %}{{ cat }}{% endif %}
            </p>
            <p class="text-2xl font-bold text-gray-800">{{ count }}</p>
        </div>
        {% endfor %}
        {% if global_stats.unknown_traffic > 0 %}
        <div class="bg-white rounded-xl shadow p-4 text-center border-t-4 border-orange-400">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">üîç Projet Inconnu</p>
            <p class="text-2xl font-bold text-orange-600">{{ global_stats.unknown_traffic }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Projects Table -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">üèÜ Classement des Projets</h2>
            <div class="text-sm text-gray-500">
                Crit√®res: Respect des topics, Volum√©trie, Fr√©quence
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-gray-600 text-sm uppercase tracking-wider">
                        <th class="p-4 font-semibold">Projet</th>
                        <th class="p-4 font-semibold text-center">Score</th>
                        <th class="p-4 font-semibold text-center">Conformit√©</th>
                        <th class="p-4 font-semibold text-center">Volume</th>
                        <th class="p-4 font-semibold text-right">Dernier Message</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for project in projects %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="p-4">
                            <div class="font-bold text-gray-800">{{ project.name }}</div>
                            <div class="text-xs text-gray-400">{{ project.total }} messages</div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full font-bold text-white shadow-sm
                            {% if project.score >= 90 %} bg-green-500
                            {% elif project.score >= 70 %} bg-blue-500
                            {% elif project.score >= 50 %} bg-orange-500
                            {% else %} bg-red-500 {% endif %}">
                                {{ project.score }}
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 max-w-[100px] mx-auto">
                                <div class="bg-blue-600 h-2.5 rounded-full"
                                    style="width: {{ project.compliance_rate }}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 mt-1 block">{{ project.compliance_rate }}%</span>
                        </td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-medium
                            {% if project.volume == 'Normal' %} bg-green-100 text-green-800
                            {% elif project.volume == 'High' %} bg-orange-100 text-orange-800
                            {% else %} bg-gray-100 text-gray-800 {% endif %}">
                                {{ project.volume }}
                            </span>
                        </td>
                        <td class="p-4 text-right text-sm text-gray-600 font-mono">
                            {{ project.last_seen }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="p-8 text-center text-gray-500">
                            Aucun projet d√©tect√© pour le moment.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Rules Reminder -->
    <div class="mt-8 bg-blue-50 border border-blue-100 rounded-2xl p-6">
        <h3 class="text-lg font-bold text-blue-900 mb-4">üìù Rappel des R√®gles de Communication</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h4 class="font-bold text-blue-800 mb-2">üü¢ Dashboard (Public)</h4>
                <code
                    class="block bg-white p-3 rounded border border-blue-200 text-sm mb-2">bzh/mecatro/dashboard/&lt;PROJET&gt;/&lt;VAR&gt;</code>
                <p class="text-sm text-blue-700">Pour afficher des valeurs sur l'√©cran g√©ant.</p>
            </div>
            <div>
                <h4 class="font-bold text-blue-800 mb-2">üîµ T√©l√©commande (Priv√©)</h4>
                <code
                    class="block bg-white p-3 rounded border border-blue-200 text-sm mb-2">bzh/mecatro/projets/&lt;GROUPE&gt;/capteurs/...</code>
                <code
                    class="block bg-white p-3 rounded border border-blue-200 text-sm mb-2">bzh/mecatro/projets/&lt;GROUPE&gt;/actionneurs/...</code>
                <p class="text-sm text-blue-700">Pour la communication interne entre maquette et appli.</p>
            </div>
        </div>
    </div>

</body>

</html>