<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ferme Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                üõ†Ô∏è Administration
            </h1>
            <div class="flex gap-4">
                <a href="/" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    üìä Dashboard
                </a>
                <a href="/logout" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    üö™ D√©connexion
                </a>
            </div>
        </div>

        <!-- Warning Banner -->
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8 rounded-lg">
            <div class="flex items-center">
                <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                <div>
                    <p class="font-bold text-red-800">Attention : Suppression permanente</p>
                    <p class="text-red-700 text-sm">Les suppressions effectu√©es ici sont <strong>d√©finitives</strong> et
                        suppriment toutes les donn√©es de la base de donn√©es. Il n'y a pas d'annulation possible.</p>
                </div>
            </div>
        </div>

        <!-- Modules List -->
        {% if modules %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for module, variables in modules.items() %}
            <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow module-card"
                data-module="{{ module | tojson }}">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold text-gray-800 capitalize">{{ module.replace('_', ' ') }}</h2>
                    <button
                        class="delete-module-btn px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors"
                        title="Supprimer le module entier">
                        üóëÔ∏è Module
                    </button>
                </div>

                <div class="space-y-2">
                    <p class="text-sm text-gray-600 font-semibold mb-2">Variables ({{ variables|length }}) :</p>
                    {% for variable in variables %}
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg hover:bg-gray-100 transition-colors variable-row"
                        data-variable="{{ variable | tojson }}">
                        <span class="text-gray-700">{{ variable }}</span>
                        <button
                            class="delete-var-btn px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600 transition-colors"
                            title="Supprimer cette variable">
                            ‚ùå
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
            <p class="text-gray-500 text-lg">Aucun module trouv√© dans la base de donn√©es.</p>
            <p class="text-gray-400 text-sm mt-2">Les modules appara√Ætront ici d√®s qu'ils publieront des donn√©es.</p>
        </div>
        {% endif %}
    </div>

    <script>
        // Use event delegation for delete buttons to handle special characters in names
        document.addEventListener('DOMContentLoaded', function () {
            // Delete variable buttons
            document.querySelectorAll('.delete-var-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const varRow = this.closest('.variable-row');
                    const moduleCard = this.closest('.module-card');
                    const variable = JSON.parse(varRow.dataset.variable);
                    const module = JSON.parse(moduleCard.dataset.module);
                    deleteVariable(module, variable, varRow, moduleCard);
                });
            });

            // Delete module buttons
            document.querySelectorAll('.delete-module-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const moduleCard = this.closest('.module-card');
                    const module = JSON.parse(moduleCard.dataset.module);
                    deleteModule(module, moduleCard);
                });
            });
        });

        function deleteVariable(module, variable, varElement, moduleCard) {
            if (!confirm(`‚ö†Ô∏è Supprimer d√©finitivement la variable "${variable}" du module "${module}" ?\n\nToutes les mesures associ√©es seront supprim√©es de la base de donn√©es.`)) {
                return;
            }

            fetch('/api/admin/delete-variable', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ module, variable })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the variable element with fade-out
                        if (varElement) {
                            varElement.style.transition = 'opacity 0.3s';
                            varElement.style.opacity = '0';
                            setTimeout(() => {
                                varElement.remove();

                                // Check if module has no more variables
                                const remainingVars = moduleCard.querySelectorAll('.variable-row');
                                if (remainingVars.length === 0) {
                                    moduleCard.style.transition = 'opacity 0.3s';
                                    moduleCard.style.opacity = '0';
                                    setTimeout(() => moduleCard.remove(), 300);
                                }
                            }, 300);
                        }

                        alert(`‚úÖ Variable "${variable}" supprim√©e (${data.deleted} mesures supprim√©es)`);
                    } else {
                        alert('‚ùå Erreur lors de la suppression: ' + (data.error || 'Inconnue'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Erreur r√©seau');
                });
        }

        function deleteModule(module, moduleCard) {
            if (!confirm(`‚ö†Ô∏è ATTENTION : Supprimer d√©finitivement le module "${module}" ?\n\nToutes les variables et mesures associ√©es seront supprim√©es de la base de donn√©es.\n\nCette action est IRR√âVERSIBLE.`)) {
                return;
            }

            fetch('/api/admin/delete-module', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ module })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the module card with fade-out
                        if (moduleCard) {
                            moduleCard.style.transition = 'opacity 0.3s';
                            moduleCard.style.opacity = '0';
                            setTimeout(() => moduleCard.remove(), 300);
                        }

                        alert(`‚úÖ Module "${module}" supprim√©\n${data.deleted.measurements} mesures supprim√©es\n${data.deleted.publications} publications supprim√©es`);
                    } else {
                        alert('‚ùå Erreur lors de la suppression: ' + (data.error || 'Inconnue'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Erreur r√©seau');
                });
        }
    </script>
</body>

</html>