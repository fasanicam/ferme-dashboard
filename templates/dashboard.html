<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Dashboard Ferme connect√©e</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå±</text></svg>">
  <style>
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .highlight {
      animation: highlight 3s ease-out;
    }

    @keyframes highlight {
      0% {
        background-color: #dcfce7;
      }

      100% {
        background-color: transparent;
      }
    }

    /* Title Animation */
    @keyframes float {
      0% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-5px);
      }

      100% {
        transform: translateY(0px);
      }
    }

    .animate-float {
      animation: float 3s ease-in-out infinite;
    }

    /* Modal styles */
    .modal {
      transition: opacity 0.25s ease;
    }

    body.modal-active {
      overflow-x: hidden;
      overflow-y: visible !important;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans p-6">
  <div class="relative flex justify-center items-center mb-6">
    <h1
      class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-teal-500 drop-shadow-sm flex items-center gap-3">
      <span class="animate-float text-5xl">üå±</span> Dashboard - Ferme connect√©e
    </h1>
    <div class="absolute right-0 flex items-center gap-3">
      <a href="/analysis"
        class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-full shadow-sm hover:shadow-md transition-all flex items-center gap-2 font-medium text-sm">
        <span>üìä</span>
        <span>Analyse MQTT</span>
      </a>
      <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-green-100">
        <span class="relative flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
        </span>
        <span class="text-sm font-medium text-gray-600">Live</span>
      </div>
    </div>
  </div>

  <div id="dashboard-container"
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
    {% if dashboard %}
    {% for module, variables in dashboard.items() %}
    <div id="module-{{ module }}"
      class="bg-white rounded-2xl shadow-lg p-6 fade-in hover:shadow-xl transition-shadow duration-300 group">
      <div class="flex justify-between items-center mb-4 border-b pb-2">
        <h2 class="text-xl font-bold capitalize text-gray-700">{{ module.replace("_", " ") }}</h2>
        <button onclick='deleteModule({{ module | tojson }})'
          class="opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full p-2"
          title="Supprimer ce module">
          üóëÔ∏è
        </button>
      </div>
      <div id="vars-{{ module }}" class="space-y-3 max-h-96 overflow-y-auto pr-2"
        style="scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.3) transparent;">
        {% for variable, value in variables.items() %}
        <div id="var-{{ module }}-{{ variable }}" class="border-b border-gray-100 pb-3 last:border-0 group/var">
          <div class="flex justify-between items-start mb-2">
            <span class="text-gray-600 font-medium">{{ variable.replace("_", " ") }}</span>
            <div class="text-right">
              <div class="flex items-center justify-end gap-2">
                <div class="value font-bold text-gray-900 text-lg">{{ value.valeur }}</div>
                <button onclick='openChart({{ module | tojson }}, {{ variable | tojson }})'
                  class="text-gray-400 hover:text-blue-500 transition-colors p-1 rounded-full hover:bg-blue-50"
                  title="Voir l'historique">
                  üìä
                </button>
                <button onclick='deleteVariable({{ module | tojson }}, {{ variable | tojson }})'
                  class="opacity-0 group-hover/var:opacity-100 transition-opacity text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full p-1"
                  title="Supprimer cette variable">
                  ‚ùå
                </button>
              </div>
              <div class="timestamp text-xs text-gray-400" data-time="{{ value.derniere_maj }}">üïí {{
                delay(value.derniere_maj) }}</div>
            </div>
          </div>
          <!-- Sparkline chart -->
          <canvas id="sparkline-{{ module }}-{{ variable }}" class="w-full h-12" style="max-height: 48px;"></canvas>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
    {% else %}
    <p id="no-data-msg" class="text-gray-500 col-span-full text-center py-10 text-lg">Aucune donn√©e re√ßue pour le
      moment. En
      attente de messages MQTT...</p>
    {% endif %}
  </div>

  <!-- Charts Section -->
  <div class="mt-12 grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Message Stats -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">üìà Activit√© globale (tous projets)</h2>
      <canvas id="messageStatsChart"></canvas>
    </div>

    <!-- Publication Trends -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">üìä Publications par heure (12h)</h2>
      <canvas id="publicationStatsChart"></canvas>
    </div>
  </div>

  <!-- Rate Limit Status & Recent Activity -->
  <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Rate Limit Status -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800">‚è±Ô∏è Statut Rate Limit</h2>
        <button onclick="showRateLimitInfo()"
          class="text-blue-600 hover:text-blue-800 text-2xl cursor-pointer transition-transform hover:scale-110"
          title="Qu'est-ce que le rate limit ?">
          ‚ÑπÔ∏è
        </button>
      </div>
      <div id="rate-limit-status" class="space-y-2 max-h-80 overflow-y-auto pr-2">
        <p class="text-gray-500 text-sm">Chargement...</p>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">üîî Derniers messages MQTT</h2>
      <div id="messages-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
        {% for message in messages %}
        <div
          class="flex justify-between items-center border-b border-gray-100 pb-2 fade-in hover:bg-gray-50 rounded px-2 transition-colors">
          <span class="text-gray-600 font-medium">{{ message.topic }}</span>
          <div class="text-right">
            <div class="font-bold text-gray-900">{{ message.payload }}</div>
            <div class="text-xs text-gray-400">üïí {{ delay(message.timestamp) }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- MQTT Analysis Section -->
  <div class="mt-12">
    <h2 class="text-3xl font-bold mb-6 text-gray-800 flex items-center gap-3">
      üìä Analyse & Scoring MQTT
      <span class="text-sm font-normal text-gray-500">(Cliquez sur un projet pour plus de d√©tails)</span>
    </h2>

    <!-- Global Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white">
        <h3 class="text-blue-100 font-medium mb-1">Messages Analys√©s</h3>
        <p id="mqtt-total" class="text-4xl font-bold">-</p>
        <p class="text-xs text-blue-100 mt-2">Sur l'ensemble de l'historique</p>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-6 text-white">
        <h3 class="text-green-100 font-medium mb-1">Taux de Conformit√© Global</h3>
        <p id="mqtt-compliance" class="text-4xl font-bold">-%</p>
        <p class="text-xs text-green-100 mt-2">Respect de la structure des topics</p>
      </div>
      <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
        <h3 class="text-purple-100 font-medium mb-1">Projets Actifs (24h)</h3>
        <p id="mqtt-projects" class="text-4xl font-bold">-</p>
        <p class="text-xs text-purple-100 mt-2">Ayant publi√© au moins un message</p>
      </div>
    </div>

    <!-- Project Cards -->
    <div id="mqtt-analysis-projects" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <p class="text-gray-500 col-span-full text-center py-8">Chargement de l'analyse...</p>
    </div>
  </div>

  <!-- Project Detail Modal -->
  <div id="projectDetailModal"
    class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeProjectDetail()"></div>
    <div class="modal-container bg-white max-w-sm mx-auto rounded-2xl shadow-2xl z-50">
      <div class="modal-content py-3 text-left px-3 border-b">
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-bold text-gray-800" id="projectDetailTitle">Analyse D√©taill√©e</h3>
          <button class="modal-close cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full transition-colors"
            onclick="closeProjectDetail()">
            <svg class="fill-current text-gray-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 18 18">
              <path
                d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
              </path>
            </svg>
          </button>
        </div>
      </div>
      <div id="projectDetailContent" class="px-3 py-3"
        style="max-height: 50vh; overflow-y: scroll !important; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #4B5563 #E5E7EB;">
        <p class="text-gray-500">Chargement...</p>
      </div>
    </div>
  </div>


  <!-- Rate Limit Info Modal -->
  <div id="rateLimitInfoModal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div
      class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl mx-4 transform transition-transform duration-300 scale-95">
      <div class="flex justify-between items-start mb-6">
        <h2 class="text-2xl font-bold text-gray-800">‚è±Ô∏è Qu'est-ce que le Rate Limit ?</h2>
        <button onclick="hideRateLimitInfo()"
          class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
      </div>

      <div class="space-y-4 text-gray-700">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
          <p class="font-semibold text-blue-900 mb-2">üìö D√©finition simple :</p>
          <p>Le <strong>rate limit</strong> est une protection qui limite la fr√©quence de sauvegarde des donn√©es dans la
            base de donn√©es.</p>
        </div>

        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
          <p class="font-semibold text-green-900 mb-2">‚úÖ R√®gle actuelle :</p>
          <p class="text-lg"><strong>Maximum 1 sauvegarde toutes les 5 secondes</strong> par variable</p>
        </div>

        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
          <p class="font-semibold text-orange-900 mb-2">‚ö†Ô∏è Que se passe-t-il si je publie trop vite ?</p>
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li>Le dashboard affiche toujours la nouvelle valeur en temps r√©el</li>
            <li>Mais la base de donn√©es <strong>n'enregistre PAS</strong> si moins de 5 secondes se sont √©coul√©es</li>
            <li>Les messages trop fr√©quents sont <strong>ignor√©s</strong> pour prot√©ger le syst√®me</li>
          </ul>
        </div>

        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
          <p class="font-semibold text-purple-900 mb-2">üìä Exemple concret :</p>
          <div class="mt-2 font-mono text-sm bg-white p-3 rounded border">
            <div class="text-green-600">‚úì 12:00:00 ‚Üí temp√©rature = 20¬∞C (sauvegard√©)</div>
            <div class="text-red-600">‚úó 12:00:02 ‚Üí temp√©rature = 21¬∞C (ignor√©, trop t√¥t)</div>
            <div class="text-red-600">‚úó 12:00:04 ‚Üí temp√©rature = 22¬∞C (ignor√©, trop t√¥t)</div>
            <div class="text-green-600">‚úì 12:00:05 ‚Üí temp√©rature = 23¬∞C (sauvegard√©)</div>
          </div>
        </div>

        <div class="bg-gray-50 p-4 rounded">
          <p class="font-semibold text-gray-900 mb-2">üí° Pourquoi cette limite ?</p>
          <p>Pour √©viter de surcharger la base de donn√©es et garantir de bonnes performances pour tous les projets.</p>
        </div>
      </div>

      <div class="mt-6 text-center">
        <button onclick="hideRateLimitInfo()"
          class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
          J'ai compris !
        </button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="chartModal"
    class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50 backdrop-blur-sm"></div>

    <div
      class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-95">
      <div class="modal-content py-6 text-left px-8">
        <div class="flex justify-between items-center pb-4 border-b">
          <p class="text-2xl font-bold text-gray-800" id="modalTitle">Historique</p>
          <div class="modal-close cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full transition-colors"
            onclick="closeModal()">
            <svg class="fill-current text-gray-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 18 18">
              <path
                d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
              </path>
            </svg>
          </div>
        </div>

        <div class="my-6 h-96">
          <canvas id="historyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io(window.location.origin, {
      transports: ['websocket', 'polling'],  // Try WebSocket first, fallback to polling
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      reconnectionAttempts: Infinity,
      timeout: 20000,           // Increase connection timeout
      pingTimeout: 60000,       // Increase ping timeout to prevent session expiry
      pingInterval: 25000       // Send ping every 25s to keep alive
    });

    // Connection status monitoring
    socket.on('connect', () => {
      console.log('[Socket.IO] ‚úÖ Connected (polling) - ID:', socket.id);
      updateConnectionStatus(true);
    });

    socket.on('disconnect', (reason) => {
      console.log('[Socket.IO] ‚ùå Disconnected - Reason:', reason);
      updateConnectionStatus(false);
      if (reason === 'io server disconnect') {
        // Server disconnected, reconnect manually
        socket.connect();
      }
    });

    socket.on('connect_error', (error) => {
      console.error('[Socket.IO] ‚ö†Ô∏è Connection Error:', error.message);
      updateConnectionStatus(false);
    });

    socket.on('reconnect_attempt', (attemptNumber) => {
      console.log('[Socket.IO] üîÑ Reconnection attempt:', attemptNumber);
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log('[Socket.IO] ‚úÖ Reconnected after', attemptNumber, 'attempts');
      updateConnectionStatus(true);
    });

    function updateConnectionStatus(connected) {
      const statusIndicator = document.querySelector('.relative.flex.h-3.w-3');
      if (statusIndicator && statusIndicator.parentElement) {
        if (connected) {
          statusIndicator.querySelector('.bg-green-500').style.backgroundColor = '#22c55e'; // green
          statusIndicator.parentElement.querySelector('span.text-sm').textContent = 'Live';
        } else {
          statusIndicator.querySelector('.bg-green-500').style.backgroundColor = '#ef4444'; // red
          statusIndicator.parentElement.querySelector('span.text-sm').textContent = 'D√©connect√©';
        }
      }
    }

    let messageStatsChartInstance = null;
    let publicationStatsChartInstance = null;
    let historyChartInstance = null;

    // --- Utils ---
    function timeSince(timestamp) {
      const date = new Date(timestamp);
      const seconds = Math.floor((new Date() - date) / 1000);
      let interval = seconds / 31536000;
      if (interval >= 2) return Math.floor(interval) + " ans";
      if (interval >= 1) return "1 an";
      interval = seconds / 2592000;
      if (interval >= 2) return Math.floor(interval) + " mois";
      if (interval >= 1) return "1 mois";
      interval = seconds / 604800;
      if (interval >= 2) return Math.floor(interval) + " semaines";
      if (interval >= 1) return "1 semaine";
      interval = seconds / 86400;
      if (interval >= 2) return Math.floor(interval) + " jours";
      if (interval >= 1) return "1 jour";
      interval = seconds / 3600;
      if (interval >= 2) return Math.floor(interval) + " heures";
      if (interval >= 1) return "1 heure";
      interval = seconds / 60;
      if (interval >= 2) return Math.floor(interval) + " minutes";
      if (interval >= 1) return "1 minute";
      if (seconds < 10) return "quelques secondes";
      return Math.floor(seconds) + " secondes";
    }

    // Rate Limit Info Modal
    function showRateLimitInfo() {
      const modal = document.getElementById('rateLimitInfoModal');
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modal.querySelector('.bg-white').classList.remove('scale-95');
      modal.querySelector('.bg-white').classList.add('scale-100');
    }

    function hideRateLimitInfo() {
      const modal = document.getElementById('rateLimitInfoModal');
      modal.classList.add('opacity-0', 'pointer-events-none');
      modal.querySelector('.bg-white').classList.remove('scale-100');
      modal.querySelector('.bg-white').classList.add('scale-95');
    }

    function updateTimestamps() {
      document.querySelectorAll('.timestamp').forEach(el => {
        const isoTime = el.getAttribute('data-time');
        if (isoTime) {
          el.innerHTML = 'üïí il y a ' + timeSince(new Date(isoTime));
        }
      });
    }
    setInterval(updateTimestamps, 10000);

    // --- Delete Functions ---
    function deleteVariable(module, variable) {
      const varDiv = document.getElementById(`var-${module}-${variable}`);
      if (varDiv) {
        // Fade out animation
        varDiv.style.opacity = '0';
        varDiv.style.transform = 'translateX(20px)';
        varDiv.style.transition = 'all 0.3s ease-out';

        setTimeout(() => {
          varDiv.remove();

          // Destroy sparkline chart if exists
          const chartKey = `${module}-${variable}`;
          if (sparklineCharts[chartKey]) {
            sparklineCharts[chartKey].destroy();
            delete sparklineCharts[chartKey];
          }

          // Check if module has no more variables
          const varsContainer = document.getElementById(`vars-${module}`);
          if (varsContainer && varsContainer.children.length === 0) {
            deleteModule(module);
          }
        }, 300);
      }
    }

    function deleteModule(module) {
      const moduleDiv = document.getElementById(`module-${module}`);
      if (moduleDiv) {
        // Confirm deletion
        if (!confirm(`Supprimer le module "${module}" et toutes ses variables ?`)) {
          return;
        }

        // Fade out animation
        moduleDiv.style.opacity = '0';
        moduleDiv.style.transform = 'scale(0.95)';
        moduleDiv.style.transition = 'all 0.3s ease-out';

        setTimeout(() => {
          moduleDiv.remove();

          // Destroy all sparkline charts for this module
          Object.keys(sparklineCharts).forEach(key => {
            if (key.startsWith(`${module}-`)) {
              sparklineCharts[key].destroy();
              delete sparklineCharts[key];
            }
          });

          // Check if dashboard is empty
          const container = document.getElementById('dashboard-container');
          if (container && container.children.length === 0) {
            container.innerHTML = '<div id="no-data-msg" class="col-span-full text-center text-gray-500 py-12">Aucune donn√©e disponible. En attente de messages MQTT...</div>';
          }

          // Update publication stats chart to remove the deleted module's line
          updatePublicationStats();
        }, 300);
      }
    }

    // --- Sparkline Charts ---
    const sparklineCharts = {};

    function createSparkline(module, variable) {
      const canvasId = `sparkline-${module}-${variable}`;
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const chartKey = `${module}-${variable}`;

      // Create gradient for sparkline
      const gradient = ctx.createLinearGradient(0, 0, 0, 48);
      gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
      gradient.addColorStop(1, 'rgba(59, 130, 246, 0.01)');

      // Create mini chart
      sparklineCharts[chartKey] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            data: [],
            borderColor: 'rgba(59, 130, 246, 0.9)',
            backgroundColor: gradient,
            borderWidth: 2,
            tension: 0.4,
            pointRadius: 0,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 750,
            easing: 'easeInOutQuart'
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          },
          scales: {
            x: { display: false },
            y: { display: false }
          },
          interaction: { mode: null }
        }
      });

      // Load data for sparkline (last 20 points)
      updateSparkline(module, variable);
    }

    function updateSparkline(module, variable) {
      const chartKey = `${module}-${variable}`;
      fetch(`/api/history/${module}/${variable}`)
        .then(response => response.json())
        .then(data => {
          if (sparklineCharts[chartKey] && data.length > 0) {
            // Take last 20 points for sparkline
            const recentData = data.slice(-20);
            const values = recentData.map(d => {
              const val = parseFloat(d[0]);
              return isNaN(val) ? null : val;
            });

            sparklineCharts[chartKey].data.labels = recentData.map(() => '');
            sparklineCharts[chartKey].data.datasets[0].data = values;
            sparklineCharts[chartKey].update(); // Smooth animation on update
          }
        })
        .catch(err => console.log('Sparkline update skipped:', err));
    }

    function initAllSparklines() {
      // Find all sparkline canvases and create charts
      document.querySelectorAll('[id^="sparkline-"]').forEach(canvas => {
        const parts = canvas.id.replace('sparkline-', '').split('-');
        if (parts.length >= 2) {
          const variable = parts.pop();
          const module = parts.join('-');
          createSparkline(module, variable);
        }
      });
    }

    // --- Charts ---
    function initMessageStatsChart() {
      const ctx = document.getElementById('messageStatsChart').getContext('2d');

      // Create gradient matching sparklines
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
      gradient.addColorStop(1, 'rgba(59, 130, 246, 0.01)');

      messageStatsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Messages par minute',
              data: [],
              backgroundColor: gradient,
              borderColor: 'rgba(59, 130, 246, 0.9)',
              borderWidth: 2,
              tension: 0.4,
              pointRadius: 3,
              pointBackgroundColor: 'rgba(59, 130, 246, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointHoverRadius: 5,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          animation: {
            duration: 750,
            easing: 'easeInOutQuart'
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              labels: {
                color: 'rgb(75, 85, 99)',
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });
      updateMessageStats();
    }

    function updateMessageStats() {
      fetch('/api/stats/messages')
        .then(response => response.json())
        .then(data => {
          if (messageStatsChartInstance) {
            const labels = data.map(d => d[0].split(' ')[1]);
            const values = data.map(d => d[1]);

            messageStatsChartInstance.data.labels = labels;
            messageStatsChartInstance.data.datasets[0].data = values;

            messageStatsChartInstance.update();
          }
        });
    }

    // --- Publication Stats Chart (Trend Lines) ---
    const moduleColors = [
      { border: 'rgba(59, 130, 246, 0.9)', bg: 'rgba(59, 130, 246, 0.1)' },  // Blue
      { border: 'rgba(239, 68, 68, 0.9)', bg: 'rgba(239, 68, 68, 0.1)' },    // Red
      { border: 'rgba(34, 197, 94, 0.9)', bg: 'rgba(34, 197, 94, 0.1)' },    // Green
      { border: 'rgba(251, 146, 60, 0.9)', bg: 'rgba(251, 146, 60, 0.1)' },  // Orange
      { border: 'rgba(168, 85, 247, 0.9)', bg: 'rgba(168, 85, 247, 0.1)' },  // Purple
      { border: 'rgba(236, 72, 153, 0.9)', bg: 'rgba(236, 72, 153, 0.1)' },  // Pink
    ];

    function initPublicationStatsChart() {
      const ctx = document.getElementById('publicationStatsChart').getContext('2d');

      publicationStatsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: []
        },
        options: {
          responsive: true,
          animation: {
            duration: 750,
            easing: 'easeInOutQuart'
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Messages / heure',
                color: 'rgb(75, 85, 99)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: 'rgb(75, 85, 99)',
                font: {
                  size: 11
                },
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `${context.dataset.label}: ${context.parsed.y} msg / h`;
                }
              }
            }
          }
        }
      });
      updatePublicationStats();
    }

    function updatePublicationStats() {
      fetch('/api/stats/publications')
        .then(response => response.json())
        .then(data => {
          if (publicationStatsChartInstance && data.length > 0) {
            // data format: [[module, hour, count], ...]
            // Group by module and hour
            const moduleData = {};
            const allHours = new Set();

            data.forEach(([module, hour, count]) => {
              // Only include modules that are currently visible on the dashboard
              if (document.getElementById(`module-${module}`)) {
                if (!moduleData[module]) {
                  moduleData[module] = {};
                }
                moduleData[module][hour] = count;
                allHours.add(hour);
              }
            });

            // Sort hours
            const sortedHours = Array.from(allHours).sort();

            // Create datasets for each module
            const datasets = Object.keys(moduleData).map((module, index) => {
              const colorIndex = index % moduleColors.length;
              const values = sortedHours.map(hour => moduleData[module][hour] || 0);

              return {
                label: module,
                data: values,
                borderColor: moduleColors[colorIndex].border,
                backgroundColor: moduleColors[colorIndex].bg,
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: moduleColors[colorIndex].border,
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                pointHoverRadius: 5,
                fill: false
              };
            });

            // Format hour labels (show only HH:00)
            const labels = sortedHours.map(h => h.split(' ')[1] || h.split('T')[1] || h);

            publicationStatsChartInstance.data.labels = labels;
            publicationStatsChartInstance.data.datasets = datasets;
            publicationStatsChartInstance.update();
          }
        });
    }

    // --- Rate Limit Status ---
    function updateRateLimitStatus() {
      fetch('/api/stats/rate-limit')
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById('rate-limit-status');
          container.innerHTML = ''; // Clear first

          if (Object.keys(data).length === 0) {
            const p = document.createElement('p');
            p.className = 'text-gray-500 text-sm';
            p.textContent = 'Aucune donn√©e disponible';
            container.appendChild(p);
            return;
          }

          for (const [module, variables] of Object.entries(data)) {
            const limitedCount = variables.filter(v => v.is_limited).length;
            const totalCount = variables.length;
            const statusColor = limitedCount > 0 ? 'text-orange-600' : 'text-green-600';
            const statusIcon = limitedCount > 0 ? '‚è≥' : '‚úÖ';

            const div = document.createElement('div');
            div.className = 'border-b border-gray-100 pb-2 last:border-0';

            const innerDiv = document.createElement('div');
            innerDiv.className = 'flex justify-between items-center';

            const moduleName = document.createElement('span');
            moduleName.className = 'font-medium text-gray-700';
            moduleName.textContent = module;

            const status = document.createElement('span');
            status.className = `${statusColor} text-sm font-semibold cursor-help`;
            status.textContent = `${statusIcon} ${limitedCount}/${totalCount} limit√©(s)`;

            // Add tooltip explaining rate limiting
            if (limitedCount > 0) {
              status.title = `‚ö†Ô∏è ${limitedCount} variable(s) en rate limit (5s minimum entre sauvegardes).\nLes messages trop fr√©quents sont ignor√©s pour prot√©ger la base de donn√©es.`;
            } else {
              status.title = `‚úÖ Aucune variable limit√©e actuellement.\nRate limit: 5s minimum entre sauvegardes DB par variable.`;
            }

            innerDiv.appendChild(moduleName);
            innerDiv.appendChild(status);
            div.appendChild(innerDiv);
            container.appendChild(div);
          }
        });
    }

    // Refresh stats every minute
    setInterval(updateMessageStats, 60000);
    setInterval(updatePublicationStats, 60000);
    setInterval(updateRateLimitStatus, 5000); // Update rate limit more frequently

    // --- Modal & History Chart ---
    function openChart(module, variable) {
      const modal = document.getElementById('chartModal');

      // Show the modal
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modal.querySelector('.modal-container').classList.remove('scale-95');
      modal.querySelector('.modal-container').classList.add('scale-100');

      document.getElementById('modalTitle').innerText = `${module} - ${variable} `;
      document.body.classList.add('modal-active');

      fetch(`/api/history/${module}/${variable}`)
        .then(response => response.json())
        .then(data => {
          const ctx = document.getElementById('historyChart').getContext('2d');

          if (historyChartInstance) {
            historyChartInstance.destroy();
          }

          const labels = data.map(d => new Date(d[1]).toLocaleTimeString());
          const values = data.map(d => {
            const val = parseFloat(d[0]);
            return isNaN(val) ? null : val;
          });

          historyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: variable,
                data: values,
                borderColor: 'rgb(59, 130, 246)',
                tension: 0.1,
                fill: false
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: { display: true },
                y: { beginAtZero: false }
              }
            }
          });
        });
    }

    function closeModal() {
      const modal = document.getElementById('chartModal');
      modal.classList.add('opacity-0', 'pointer-events-none');
      modal.querySelector('.modal-container').classList.remove('scale-100');
      modal.querySelector('.modal-container').classList.add('scale-95');
      document.body.classList.remove('modal-active');
    }

    document.querySelector('.modal-overlay').addEventListener('click', closeModal);

    // --- Socket.IO ---
    socket.on('new_message', function (message) {
      console.log('[Socket.IO] üì• Received new_message:', message);
      const messagesList = document.getElementById('messages-list');
      if (!messagesList) return;

      // Create new message element
      const div = document.createElement('div');
      div.className = 'flex justify-between items-center border-b border-gray-100 pb-2 fade-in hover:bg-gray-50 rounded px-2 transition-colors';
      div.innerHTML = `
          <span class="text-gray-600 font-medium">${message.topic}</span>
          <div class="text-right">
            <div class="font-bold text-gray-900">${message.payload}</div>
            <div class="text-xs text-gray-400">üïí ${timeSince(message.timestamp)}</div>
          </div>
        `;

      // Add to top of list
      messagesList.prepend(div);

      // Limit to 10 messages
      if (messagesList.children.length > 10) {
        messagesList.lastElementChild.remove();
      }
    });


    socket.on('update_data', function (data) {
      console.log('[Socket.IO] üì• Received update_data:', data);
      const module = data.module;
      const variable = data.variable;
      const value = data.value;
      const timestamp = data.timestamp;

      // Remove "no data" message if exists
      const noDataMsg = document.getElementById('no-data-msg');
      if (noDataMsg) noDataMsg.remove();

      // Check if module exists
      let moduleDiv = document.getElementById(`module-${module}`);
      if (!moduleDiv) {
        const container = document.getElementById('dashboard-container');
        moduleDiv = document.createElement('div');
        moduleDiv.id = `module-${module}`;
        moduleDiv.className = 'bg-white rounded-2xl shadow p-6 fade-in';
        moduleDiv.innerHTML = `
          <h2 class="text-xl font-semibold mb-4 capitalize">${module.replace(/_/g, " ")}</h2>
          <div id="vars-${module}" class="space-y-3 max-h-96 overflow-y-auto pr-2" style="scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.3) transparent;"></div>
        `;
        container.appendChild(moduleDiv);
      }

      // Check if variable exists
      let varDiv = document.getElementById(`var-${module}-${variable}`);
      if (!varDiv) {
        const varsContainer = document.getElementById(`vars-${module}`);
        varDiv = document.createElement('div');
        varDiv.id = `var-${module}-${variable}`;
        varDiv.className = 'border-b border-gray-100 pb-3 last:border-0';
        varDiv.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <span class="text-gray-600 font-medium">${variable.replace(/_/g, " ")}</span>
            <div class="text-right">
              <div class="flex items-center justify-end gap-2">
                <div class="value font-bold text-gray-900 text-lg"></div>
                <button onclick="openChart('${module}', '${variable}')" class="text-gray-400 hover:text-blue-500 transition-colors p-1 rounded-full hover:bg-blue-50" title="Voir l'historique">
                  üìä
                </button>
              </div>
              <div class="timestamp text-xs text-gray-400"></div>
            </div>
          </div>
          <canvas id="sparkline-${module}-${variable}" class="w-full h-12" style="max-height: 48px;"></canvas>
        `;
        varsContainer.appendChild(varDiv);

        // Create sparkline for new variable
        createSparkline(module, variable);
      } else {
        varDiv.classList.remove('highlight');
        void varDiv.offsetWidth; // trigger reflow
        varDiv.classList.add('highlight');
      }

      // Update values
      varDiv.querySelector('.value').textContent = value;
      const timeEl = varDiv.querySelector('.timestamp');
      timeEl.setAttribute('data-time', timestamp);
      timeEl.innerHTML = 'üïí il y a ' + timeSince(new Date(timestamp));

      // Update sparkline if it exists
      updateSparkline(module, variable);

      // Update stats charts slightly delayed to catch the new count
      setTimeout(updateMessageStats, 1000);
      setTimeout(updatePublicationStats, 1500);
      setTimeout(updateRateLimitStatus, 500);
    });

    socket.on('delete_data', function (data) {
      const varDiv = document.getElementById(`var-${data.module}-${data.variable}`);
      if (varDiv) varDiv.remove();

      const varsContainer = document.getElementById(`vars-${data.module}`);
      if (varsContainer && varsContainer.children.length === 0) {
        const moduleDiv = document.getElementById(`module-${data.module}`);
        if (moduleDiv) moduleDiv.remove();
      }
    });

    // Init
    initMessageStatsChart();
    initPublicationStatsChart();
    updateRateLimitStatus(); // Initial load
    initAllSparklines();

    // HTTP Polling fallback (since Socket.IO doesn't work through Traefik)
    let lastDashboardData = JSON.stringify({{ dashboard | tojson | safe }});

    function pollDashboardUpdates() {
      fetch('/api/dashboard/data')
        .then(response => response.json())
        .then(data => {
          const newDataStr = JSON.stringify(data.dashboard);
          if (newDataStr !== lastDashboardData) {
            lastDashboardData = newDataStr;
            updateDashboardFromData(data.dashboard);
          }
        })
        .catch(err => console.log('Poll error:', err));
    }

    function updateDashboardFromData(dashboardData) {
      // Remove "no data" message if it exists
      const noDataMsg = document.getElementById('no-data-msg');
      if (noDataMsg) noDataMsg.remove();

      for (const [module, variables] of Object.entries(dashboardData)) {
        // Check if module card exists, create if not
        let moduleDiv = document.getElementById(`module-${module}`);
        if (!moduleDiv) {
          const container = document.getElementById('dashboard-container');
          moduleDiv = document.createElement('div');
          moduleDiv.id = `module-${module}`;
          moduleDiv.className = 'bg-white rounded-2xl shadow-lg p-6 fade-in hover:shadow-xl transition-shadow duration-300 group';
          moduleDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4 border-b pb-2">
              <h2 class="text-xl font-bold capitalize text-gray-700">${module.replace(/_/g, " ")}</h2>
              <button onclick="deleteModule('${module}')"
                class="opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full p-2"
                title="Supprimer ce module">
                üóëÔ∏è
              </button>
            </div>
            <div id="vars-${module}" class="space-y-3 max-h-96 overflow-y-auto pr-2"
              style="scrollbar-width: thin; scrollbar-color: rgba(59, 130, 246, 0.3) transparent;"></div>
          `;
          container.appendChild(moduleDiv);
        }

        for (const [variable, valueData] of Object.entries(variables)) {
          let varDiv = document.getElementById(`var-${module}-${variable}`);

          // If variable card doesn't exist, create it
          if (!varDiv) {
            const varsContainer = document.getElementById(`vars-${module}`);
            varDiv = document.createElement('div');
            varDiv.id = `var-${module}-${variable}`;
            varDiv.className = 'border-b border-gray-100 pb-3 last:border-0 group/var';
            varDiv.innerHTML = `
              <div class="flex justify-between items-start mb-2">
                <span class="text-gray-600 font-medium">${variable.replace(/_/g, " ")}</span>
                <div class="text-right">
                  <div class="flex items-center justify-end gap-2">
                    <div class="value font-bold text-gray-900 text-lg">${valueData.valeur}</div>
                    <button onclick="openChart('${module}', '${variable}')"
                      class="text-gray-400 hover:text-blue-500 transition-colors p-1 rounded-full hover:bg-blue-50"
                      title="Voir l'historique">
                      üìä
                    </button>
                    <button onclick="deleteVariable('${module}', '${variable}')"
                      class="opacity-0 group-hover/var:opacity-100 transition-opacity text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full p-1"
                      title="Supprimer cette variable">
                      ‚ùå
                    </button>
                  </div>
                  <div class="timestamp text-xs text-gray-400" data-time="${valueData.derniere_maj}">üïí il y a ${timeSince(new Date(valueData.derniere_maj))}</div>
                </div>
              </div>
              <canvas id="sparkline-${module}-${variable}" class="w-full h-12" style="max-height: 48px;"></canvas>
            `;
            varsContainer.appendChild(varDiv);

            // Create sparkline for new variable
            createSparkline(module, variable);
          } else {
            // Update existing card
            varDiv.querySelector('.value').textContent = valueData.valeur;
            const timeEl = varDiv.querySelector('.timestamp');
            timeEl.setAttribute('data-time', valueData.derniere_maj);
            timeEl.innerHTML = 'üïí il y a ' + timeSince(new Date(valueData.derniere_maj));

            // Highlight animation
            varDiv.classList.remove('highlight');
            void varDiv.offsetWidth;
            varDiv.classList.add('highlight');

            // Update sparkline
            updateSparkline(module, variable);
          }
        }
      }
    }

    // Track last messages to detect new ones
    let lastMessages = [];

    // Poll for new messages
    function pollMessages() {
      fetch('/api/dashboard/messages')
        .then(response => response.json())
        .then(data => {
          const messagesList = document.getElementById('messages-list');
          if (!messagesList) return;

          // Detect new messages by comparing timestamps
          const newMessages = data.messages.filter(msg =>
            !lastMessages.some(oldMsg =>
              oldMsg.topic === msg.topic &&
              oldMsg.timestamp === msg.timestamp &&
              oldMsg.payload === msg.payload
            )
          );

          // Update lastMessages
          lastMessages = data.messages;

          // If we have new messages, add them with highlight
          if (newMessages.length > 0) {
            // Clear and rebuild, but only highlight new ones
            messagesList.innerHTML = '';
            data.messages.forEach(message => {
              const div = document.createElement('div');
              const isNew = newMessages.some(newMsg =>
                newMsg.topic === message.topic &&
                newMsg.timestamp === message.timestamp &&
                newMsg.payload === message.payload
              );

              div.className = 'flex justify-between items-center border-b border-gray-100 pb-2 hover:bg-gray-50 rounded px-2 transition-colors';
              if (isNew) {
                div.classList.add('highlight'); // Add highlight animation for new messages
              }

              div.innerHTML = `
                <span class="text-gray-600 font-medium">${message.topic}</span>
                <div class="text-right">
                  <div class="font-bold text-gray-900">${message.payload}</div>
                  <div class="text-xs text-gray-400">üïí ${timeSince(new Date(message.timestamp))}</div>
                </div>
              `;
              messagesList.appendChild(div);
            });
          } else {
            // Just update timestamps without rebuilding
            const existingDivs = messagesList.querySelectorAll('.flex');
            existingDivs.forEach((div, index) => {
              if (data.messages[index]) {
                const timestampEl = div.querySelector('.text-xs.text-gray-400');
                if (timestampEl) {
                  timestampEl.innerHTML = `üïí ${timeSince(new Date(data.messages[index].timestamp))}`;
                }
              }
            });
          }
        })
        .catch(err => console.log('Messages poll error:', err));
    }

    // Poll every 2 seconds
    setInterval(pollDashboardUpdates, 2000);
    setInterval(pollMessages, 2000);
    console.log('‚úÖ HTTP polling enabled (every 2s)');

    // --- MQTT Analysis Functions ---
    function loadMQTTAnalysis() {
      // Load global stats
      fetch('/api/mqtt/global')
        .then(response => response.json())
        .then(data => {
          document.getElementById('mqtt-total').textContent = data.total_messages.toLocaleString();
          document.getElementById('mqtt-compliance').textContent = data.compliance_rate + '%';
          document.getElementById('mqtt-projects').textContent = data.active_projects;
        })
        .catch(err => console.error('Error loading MQTT global stats:', err));

      // Load project cards
      fetch('/api/mqtt/projects')
        .then(response => response.json())
        .then(projects => {
          const container = document.getElementById('mqtt-analysis-projects');
          if (projects.length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-12">Aucune donn√©e d\'analyse disponible pour le moment.</p>';
            return;
          }

          container.innerHTML = projects.map(project => {
            const scoreColor = project.score >= 90 ? 'bg-green-500' :
              project.score >= 70 ? 'bg-blue-500' :
                project.score >= 50 ? 'bg-orange-500' : 'bg-red-500';

            // Escape HTML to prevent XSS
            const escapedName = project.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

            return `
              <div data-project="${escapedName}" 
                   class="project-card bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-xl transition-all duration-300 hover:-translate-y-1 group">
                <div class="flex justify-between items-start mb-3">
                  <div class="overflow-hidden">
                    <h3 class="text-lg font-bold text-gray-800 group-hover:text-blue-600 transition-colors truncate" title="${escapedName}">${escapedName}</h3>
                    <p class="text-xs text-gray-400 mt-0.5">${project.total} msgs</p>
                  </div>
                  <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full ${scoreColor} shadow-sm ml-2">
                    <span class="text-lg font-bold text-white">${project.score}</span>
                  </div>
                </div>
                
                <div class="space-y-2">
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-500">Conformit√©</span>
                      <span class="font-medium ${project.compliance_rate >= 80 ? 'text-green-600' : 'text-orange-600'}">${project.compliance_rate}%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5">
                      <div class="${project.compliance_rate >= 80 ? 'bg-green-500' : 'bg-orange-500'} h-1.5 rounded-full transition-all" 
                           style="width: ${project.compliance_rate}%"></div>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-center pt-2 border-t border-gray-50">
                    <span class="text-[10px] text-gray-400">üïí Dernier msg</span>
                    <span class="text-[10px] font-medium text-gray-500">${new Date(project.last_seen).toLocaleString('fr-FR')}</span>
                  </div>
                </div>
                
                <div class="mt-3 text-center">
                  <span class="text-blue-600 text-xs font-medium group-hover:underline">D√©tails ‚Üí</span>
                </div>
              </div>
            `;
          }).join('');

          // Add click event listeners to all project cards
          document.querySelectorAll('.project-card').forEach(card => {
            card.addEventListener('click', function () {
              const projectName = this.getAttribute('data-project');
              showProjectDetail(projectName);
            });
          });
        })
        .catch(err => console.error('Error loading MQTT projects:', err));
    }

    function showProjectDetail(projectName) {
      const modal = document.getElementById('projectDetailModal');
      const title = document.getElementById('projectDetailTitle');
      const content = document.getElementById('projectDetailContent');

      title.textContent = `Projet: ${projectName}`;
      content.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement des d√©tails...</p>';

      modal.classList.remove('opacity-0', 'pointer-events-none');
      document.body.classList.add('modal-active');

      // Encode project name for URL to handle special characters like quotes
      const encodedProjectName = encodeURIComponent(projectName);

      fetch(`/api/mqtt/project/${encodedProjectName}`)
        .then(response => response.json())
        .then(data => {
          const stats = data.stats;
          const compliance = ((stats.compliant / stats.total) * 100).toFixed(1);

          content.innerHTML = `
            <div class="space-y-3">
              <!-- Stats Overview -->
              <div class="grid grid-cols-2 gap-2">
                <div class="bg-blue-50 rounded p-2">
                  <p class="text-[10px] text-blue-600">Total</p>
                  <p class="text-lg font-bold text-blue-800">${stats.total}</p>
                </div>
                <div class="bg-green-50 rounded p-2">
                  <p class="text-[10px] text-green-600">Conformes</p>
                  <p class="text-lg font-bold text-green-800">${stats.compliant}</p>
                </div>
                <div class="bg-red-50 rounded p-2">
                  <p class="text-[10px] text-red-600">Erreurs</p>
                  <p class="text-lg font-bold text-red-800">${stats.total - stats.compliant}</p>
                </div>
                <div class="bg-purple-50 rounded p-2">
                  <p class="text-[10px] text-purple-600">Score</p>
                  <p class="text-lg font-bold text-purple-800">${compliance}%</p>
                </div>
              </div>

              <!-- Frequency Analysis -->
              ${data.frequency.data.length > 0 ? `
              <div class="bg-gray-50 rounded p-2">
                <h4 class="font-bold text-xs text-gray-800 mb-1">üìà Fr√©quence</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div><span class="text-gray-600">Max:</span> <span class="font-bold">${data.frequency.max} msg/min</span></div>
                  <div><span class="text-gray-600">Moy:</span> <span class="font-bold">${data.frequency.avg} msg/min</span></div>
                </div>
              </div>
              ` : ''}

              <!-- Errors -->
              ${data.errors.length > 0 ? `
              <div class="bg-red-50 border border-red-200 rounded p-2">
                <h4 class="font-bold text-xs text-red-800 mb-1">‚ùå Erreurs</h4>
                <div class="space-y-1 max-h-32 overflow-y-auto">
                  ${data.errors.slice(0, 5).map(err => `
                    <div class="flex justify-between bg-white p-1 rounded text-[10px]">
                      <code class="text-gray-700 truncate">${err.topic}</code>
                      <span class="bg-red-100 text-red-800 px-1 rounded font-bold">${err.count}x</span>
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : '<div class="bg-green-50 rounded p-2 text-center"><p class="text-green-700 text-xs font-medium">‚úÖ Aucune erreur</p></div>'}

              <!-- Categories -->
              <div class="bg-gray-50 rounded p-2">
                <h4 class="font-bold text-xs text-gray-800 mb-1">üìä Cat√©gories</h4>
                <div class="grid grid-cols-2 gap-1">
                  ${data.categories.slice(0, 4).map(cat => `
                    <div class="bg-white p-1 rounded">
                      <p class="text-[10px] text-gray-500">${cat.category}</p>
                      <p class="text-sm font-bold text-gray-800">${cat.count}</p>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Top Topics -->
              <div class="bg-gray-50 rounded p-2">
                <h4 class="font-bold text-xs text-gray-800 mb-1">üî• Topics actifs</h4>
                <div class="space-y-1 max-h-32 overflow-y-auto">
                  ${data.top_topics.slice(0, 5).map((topic, i) => `
                    <div class="flex justify-between bg-white p-1 rounded text-[10px]">
                      <div class="flex items-center gap-1">
                        <span class="bg-blue-100 text-blue-800 px-1 rounded font-bold">#${i + 1}</span>
                        <code class="text-gray-700 truncate">${topic.topic}</code>
                      </div>
                      <span class="font-medium text-gray-600">${topic.count}</span>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Timeline -->
              ${data.timeline.length > 0 ? `
              <div class="bg-gray-50 rounded-lg p-6">
                <h4 class="font-bold text-gray-800 mb-4">üìÖ Activit√© sur 24h</h4>
                <div class="space-y-1 max-h-40 overflow-y-auto">
                  ${data.timeline.slice(-12).reverse().map(t => {
            const maxCount = Math.max(...data.timeline.map(x => x.count));
            const width = (t.count / maxCount * 100).toFixed(0);
            return `
                      <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500 w-32">${new Date(t.hour).toLocaleString('fr-FR', { month: 'short', day: 'numeric', hour: '2-digit' })}</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-5">
                          <div class="bg-blue-500 h-5 rounded-full flex items-center px-2" style="width: ${width}%">
                            <span class="text-xs text-white font-medium">${t.count}</span>
                          </div>
                        </div>
                      </div>
                    `;
          }).join('')}
                </div>
              </div>
              ` : ''}

              <!-- Recent Messages -->
              ${data.recent_messages && data.recent_messages.length > 0 ? `
              <div class="bg-gray-50 rounded p-2">
                <h4 class="font-bold text-xs text-gray-800 mb-1">üì® Derniers (10)</h4>
                <div class="space-y-1 max-h-40 overflow-y-auto">
                  ${data.recent_messages.slice(0, 10).map(msg => `
                    <div class="bg-white p-1 rounded text-[10px] ${msg.is_compliant ? '' : 'border border-red-200'}">
                      <div class="flex justify-between mb-0.5">
                        <code class="text-gray-700 truncate text-[9px]">${msg.topic}</code>
                        <span class="text-gray-400 text-[9px]">${new Date(msg.timestamp).toLocaleTimeString('fr-FR')}</span>
                      </div>
                      <div class="text-gray-600 truncate">${msg.payload}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : ''}
            </div>
          `;
        })
        .catch(err => {
          console.error('Error loading project details:', err);
          content.innerHTML = '<p class="text-red-500 text-center py-8">Erreur lors du chargement des d√©tails.</p>';
        });
    }

    function closeProjectDetail() {
      const modal = document.getElementById('projectDetailModal');
      modal.classList.add('opacity-0', 'pointer-events-none');
      document.body.classList.remove('modal-active');
    }

    // Load MQTT analysis on page load and refresh every 30 seconds
    loadMQTTAnalysis();
    setInterval(loadMQTTAnalysis, 30000);
  </script>
</body>

</html>